---
layout: post
title: "[ TypeORM ] bigQeury DBë¥¼ ì´ìš©í•´ì„œ íŠ¸ë¦¬ê±°í•¨ìˆ˜ ë§Œë“¤ê¸°(typeORM subscribeê¸°ëŠ¥)"
categories: back
comments: true
---

<br>

<br>

DBì˜ ê¸°ëŠ¥ì—ëŠ” `íŠ¸ë¦¬ê±°`ì™€ `í”„ë¡œì‹œì €`ê°€ ìˆëŠ”ë°,

`íŠ¸ë¦¬ê±°`ëŠ” 'Aê°€ ëë‚˜ë©´ Bë¥¼ ì‹¤í–‰í•´ì¤˜' ë¼ëŠ” ê°œë…ì´ë¼ë©´

(Ex. ìƒí’ˆì„ ë“±ë¡í•˜ë©´ ìƒí’ˆë¡œê·¸ê°€ ìƒì„±ë˜ê²Œ í•´ì¤˜)

`í”„ë¡œì‹œì €`ëŠ” DBì—ì„œ í•¨ìˆ˜ë¥¼ ë§Œë“œëŠ” ê²ƒì´ë‹¤. (ìš”ì¦˜ì€ ë³´í†µ DBA(DBê´€ë¦¬ì)ë“¤ì´ DBê´€ë¦¬í• ë•Œ ì‚¬ìš©í•œë‹¤)

í”„ë¡œì‹œì €ëŠ” ì˜ˆì „ì— ë§ì´ ì‚¬ìš©í–ˆë˜ ê°œë…ì´ê³  ìš”ì¦˜ì€ JSë‹¨ì—ì„œ í•¨ìˆ˜ë¥¼ ìƒì„±í•´ì„œ ì‚¬ìš©í•œë‹¤.

ê·¸ë˜ì„œ ì§€ê¸ˆì€ `íŠ¸ë¦¬ê±°ë¥¼ ì´ìš©í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ì„œ ì„¤ëª…`í• ê±°ì„ à´¦àµà´¦à´¿â—â€¢á´—â€¢â—)

<br>

<br>

ì´ì œë¶€í„° ìƒí’ˆì„ ë“±ë¡í•˜ë©´(createProduct) ìƒí’ˆë¡œê·¸ë¥¼ ìƒì„±í•˜ëŠ” íŠ¸ë¦¬ê±°ë¥¼ ë§Œë“¤ê±´ë°,

ì´ ë¡œê·¸ë“¤ì„ mysqlì— ì €ì¥í•˜ê²Œ ë˜ë©´ ìš©ëŸ‰ì´ ê¸ˆë°© ë‹¤ ì°¨ë²„ë¦¬ê²Œ ëœë‹¤.

ê·¸ë˜ì„œ ì´ëŸ´ë•ŒëŠ” ë¡œê·¸ë§Œ ì €ì¥í•´ì£¼ëŠ” ë””ë¹„ê°€ ë”°ë¡œ ìˆìœ¼ë©´ ì¢‹ê² ë‹¤ëŠ” ìƒê°ì„ í•˜ê²Œë˜ëŠ”ë°,

ì´ë•Œ ì‚¬ìš©í• ìˆ˜ìˆëŠ” ë””ë¹„ê°€ GCPì—ì„œëŠ” `BigQuery`ë¼ëŠ” ë””ë¹„ê°€ ìˆë‹¤

> BigQueryë€ ìš©ëŸ‰ì˜ ì œí•œì´ ì—†ê³ , ë„£ìœ¼ë©´ ë„£ëŠ”ëŒ€ë¡œ ë‹¤ ë“¤ì–´ê°€ëŠ” dbì´ë‹¤.
>
> ê·¸ë˜ì„œ ë¡œê·¸ì„± ë°ì´í„°ë“¤ì€ ë¹…ì¿¼ë¦¬ì— ë„£ê²Œ ë˜ë©´ ìš©ëŸ‰ê±±ì •ì—†ì´ ì €ì¥í•  ìˆ˜ ìˆë‹¤.
>
> ì¡°íšŒí•˜ê¸°ë„ ë¹ ë¥´ë‹¤. ë°ì´í„° ì–‘ì´ ëŠ˜ì–´ë‚˜ë©´ ë‚˜ì¤‘ì— ì¡°íšŒí•˜ëŠ”ê²ƒë„ ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦¬ëŠ”ë°
>
> ë¹…ì¿¼ë¦¬ì—ì„œëŠ” ê·¸ëŸ° ë¬¸ì œë¥¼ í•´ê²°í•´ì¤€ë‹¤

<br>

<br>

ê·¸ëŸ¼ì´ì œ ìƒí’ˆì„ ë“±ë¡í• ë•Œ íŠ¸ë¦¬ê±°ê°€ ë°œí˜„ë˜ë„ë¡ GCP bigqueryì„¤ì •ê³¼ ì½”ë“œë¥¼ ì§œë³´ë„ë¡ í•˜ìŸˆ á§–(â€¢ á¦¢ â€¢)á¦£

---

# GCP BigQuery ì„¤ì •

ì´ì œëŠ” GCPì—ì„œ ì„¤ì •í•´ì£¼ì–´ì•¼ í•  ì°¨ë¡€

gcpì—ì„œ bigqueryë¡œ ë“¤ì–´ê°„ë‹¤

ê·¸ë¦¬ê³  `ìƒˆ ì¿¼ë¦¬ ì‘ì„±` ë²„íŠ¼ í´ë¦­

![ë¹…ì¿¼ë¦¬](/assets/img/bigquery/1.png)

ê·¸ëŸ¬ë©´ ë°ì´í„°ì„¸íŠ¸ ë§Œë“œëŠ” ì°½ì´ ë‚˜ì˜¤ëŠ”ë°, ê±°ê¸°ì„œ ì›í•˜ëŠ” ID, ì§€ì—­ì„ ì„ íƒí•˜ê³  `ë°ì´í„°ì„¸íŠ¸ ë§Œë“¤ê¸°` ë²„íŠ¼ í´ë¦­

![ë¹…ì¿¼ë¦¬](/assets/img/bigquery/2.png)

ë°ì´í„°ì„¸íŠ¸ê°€ ë§Œë“¤ì–´ì§€ë©´ `í…Œì´ë¸”ë§Œë“¤ê¸°` ë²„íŠ¼ì„ í´ë¦­í•œë‹¤

![ë¹…ì¿¼ë¦¬](/assets/img/bigquery/3.png)

ì›í•˜ëŠ” í…Œì´ë¸” ì´ë¦„ìœ¼ë¡œ í…Œì´ë¸”ì„ ìƒì„±í•œë‹¤.

![ë¹…ì¿¼ë¦¬](/assets/img/bigquery/4.png)

ê·¸ëŸ¬ë©´ ë°ì´í„°ì„¸íŠ¸ ë°‘ì— í…Œì´ë¸”ì´ ìƒˆë¡œ ìƒì„±ëœê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤

![ë¹…ì¿¼ë¦¬](/assets/img/bigquery/5.png)

ìƒì„±ëœ í…Œì´ë¸”ì„ í´ë¦­í•˜ë©´ `ìŠ¤í‚¤ë§ˆ ìˆ˜ì •` ì´ë¼ëŠ” ë²„íŠ¼ì„ ëˆŒëŸ¬ì„œ

![ë¹…ì¿¼ë¦¬](/assets/img/bigquery/6.png)

ë¹…ì¿¼ë¦¬ì— ì €ì¥í•  ë‚´ìš©ë“¤ì„ ì…ë ¥í•œë‹¤.

![ë¹…ì¿¼ë¦¬](/assets/img/bigquery/7.png)

ì´ì œëŠ” ì•”í˜¸í‚¤ë¥¼ ë°œê¸‰ë°›ì•„ì•¼í•¨. ì•”í˜¸í‚¤ë¥¼ ë°œê¸‰ë°›ëŠ” ë°©ë²•ì€

`IAM ë° ê´€ë¦¬ì > ì„œë¹„ìŠ¤ê³„ì •` ì— ë“¤ì–´ê°„ë‹¤

![ë¹…ì¿¼ë¦¬](/assets/img/bigquery/8.png)

`ì„œë¹„ìŠ¤ê³„ì • ë§Œë“¤ê¸°` ë²„íŠ¼ í´ë¦­í•˜ê¸°

![ë¹…ì¿¼ë¦¬](/assets/img/bigquery/9.png)

`ì„œë¹„ìŠ¤ê³„ì •ID` ì‘ì„±í•˜ê³  ì™„ë£Œ í•˜ê¸°

![ë¹…ì¿¼ë¦¬](/assets/img/bigquery/10.png)

`ì—‘ì„¸ìŠ¤ê¶Œí•œë¶€ì—¬` ì—ì„œëŠ” `BigQuery > BigQuery ê´€ë¦¬ì` ë¥¼ í´ë¦­í•œë‹¤

ê·¸ë¦¬ê³  `ì™„ë£Œ` ë¡œ ì„œë¹„ìŠ¤ê³„ì •ì„ ì™„ì„±í•œë‹¤.

![ë¹…ì¿¼ë¦¬](/assets/img/bigquery/11.png)

ë§Œë“¤ì–´ì§„ í‚¤ì—ì„œ `í‚¤ ê´€ë¦¬` ë¥¼ í´ë¦­í•œë‹¤

![ë¹…ì¿¼ë¦¬](/assets/img/bigquery/12.png)

ê±°ê¸°ì„œ `ìƒˆ í‚¤ ë§Œë“¤ê¸°` ëˆ„ë¥´ê³ 

![ë¹…ì¿¼ë¦¬](/assets/img/bigquery/13.png)

JSONìœ¼ë¡œ í‚¤ë¥¼ ë§Œë“ ë‹¤

![ë¹…ì¿¼ë¦¬](/assets/img/bigquery/14.png)

í‚¤ê°€ ë§Œë“¤ì–´ì¡Œë‹¤! (_â€¢Ì€á´—â€¢Ì_)Ùˆ Ì‘Ì‘

![ë¹…ì¿¼ë¦¬](/assets/img/bigquery/15.png)

<br>

<br>

<br>

<br>

ì´ì œ createProduct apië¥¼ í˜¸ì¶œí•˜ë©´ bigqueryì— ë¡œê·¸ê°€ ì˜ ìŒ“ì´ëŠ”ì§€ í™•ì¸í•˜ë©´ ëœë‹¤.

api í˜¸ì¶œí•´ì„œ ì˜ ì…ë ¥ëë‹¤ê³  ê°€ì •í•˜ê³ , ì˜ ëë‹¤ë©´

gcp bigqeuryì—ì„œ í…Œì´ë¸”ë¡œ ë“¤ì–´ê°„ë‹¤. (ë°ì´í„°ì„¸íŠ¸ë¥¼ ëˆ„ë¥´ë©´ ë‹¤ë¥¸ê²Œ ë‚˜ì˜¤ë‹ˆê¹Œ í…Œì´ë¸”ì„ í´ë¦­í•´ì•¼í•¨)

ê·¸ë¦¬ê³  `ì¿¼ë¦¬` ë¥¼ ëˆ„ë¥´ë©´ `ìƒˆíƒ­ì—ì„œ ì—´ê¸°` í˜¹ì€ `ë¶„í• íƒ­ì—ì„œ ì—´ê¸°` ë¥¼ ëˆŒëŸ¬ ì¿¼ë¦¬ë¬¸ì„ í™•ì¸í•œë‹¤

![ë¹…ì¿¼ë¦¬](/assets/img/bigquery/16.png)

ê·¸ëŸ¬ë©´ ì•„ë˜ìª½ì— `ì¿¼ë¦¬ê²°ê³¼` ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤

![ë¹…ì¿¼ë¦¬](/assets/img/bigquery/17.png)

<br>

<br>

<br>

<br>

<br>

<br>

---

# VSCODE ì—ì„œ íŠ¸ë¦¬ê±° ë§Œë“¤ì–´ë³´ê¸°

`service.ts` ì—ì„œ `createProduct` ì˜ ë¹„ì§€ë‹ˆìŠ¤ë¡œì§ì´ êµ¬í˜„ë˜ê³  ë‚˜ë©´

ì´ê±¸ ë°”ë¡œ ì•Œì•„ì±„ê³  ë‹¤ìŒ í•¨ìˆ˜ë¥¼ ì‹¤í–‰ì‹œì¼œë‹¬ë¼ëŠ” íŠ¸ë¦¬ê±°ë¥¼ ë§Œë“¤ì–´ì•¼ í•˜ëŠ”ë°

createProduct ì˜ ë¹„ì§€ë‹ˆìŠ¤ë¡œì§ì´ êµ¬í˜„ë˜ëŠ”ê±¸ typeormì—ì„œ ì•Œì•„ì°¨ë¦¬ëŠ” ê¸°ëŠ¥ì´ ì´ë¯¸ ìˆë‹¤.

ê·¸ ê¸°ëŠ¥ì´ ë°”ë¡œ subscriber ê¸°ëŠ¥ì´ë‹¤.

ì ê·¸ëŸ¼ í•œë²ˆ í•´ë´…ì‹œëŒœ

entity í´ë” ì•ˆì— product.subscriber.ts ë¼ëŠ” íŒŒì¼ì„ í•˜ë‚˜ ë§Œë“ ë‹¤.

ê·¸ë¦¬ê³  ê·¸ ë‚´ìš©ì•ˆì—ëŠ” ì•„ë˜ ì½”ë“œë¥¼ ë„£ëŠ”ë‹¤.

```ts
import {
  Connection,
  EntitySubscriberInterface,
  EventSubscriber,
  InsertEvent,
} from "typeorm";
import { Product } from "./product.entity";
import { BigQuery } from "@google-cloud/bigquery";

@EventSubscriber() //ì´ë²¤íŠ¸ê°€ ë°œìƒë˜ë©´ ë°”ë¡œ ì‹¤í–‰
export class ProductSubscriber implements EntitySubscriberInterface<Product> {
  constructor(connection: Connection) {
    connection.subscribers.push(this);
  }

  listenTo() {
    //ëˆ„êµ¬ë¥¼ ì£¼ì‹œí•˜ê³  ìˆì„ê±´ë°?
    return Product;
  }

  afterInsert(event: InsertEvent<any>): void | Promise<any> {
    console.log(event);

    const id = event.entity.id;
    const name = event.entity.name;
    const description = event.entity.description;
    const price = event.entity.price;
    const isSoldout = event.entity.isSoldout;

    console.log(`${id} ${name} ${description} ${price} ${isSoldout}`);

    const bigQuery = new BigQuery({
      keyFilename: "gcp-bigquery.json",
      projectId: "í”„ë¡œì íŠ¸ì•„ì´ë””",
    });

    bigQuery.dataset("ë¹…ì¿¼ë¦¬ë°ì´í„°ì´ë¦„").table("ë¹…ì¿¼ë¦¬í…Œì´ë¸”ëª…").insert([
      {
        id,
        name,
        description,
        price,
        isSoldout,
      },
    ]);
  }
}
```

`@EventSubscriber()` ë°ì½”ë ˆì´í„°ë¥¼ í†µí•´ íŠ¸ë¦¬ê±° ê¸°ëŠ¥ì„ í• ê±°ë¼ëŠ”ê±¸ nest.jsì— ì•Œë ¤ì£¼ì–´ì•¼ í•œë‹¤.

`export class ProductSubscriber` ì´ë ‡ê²Œë§Œ ìˆìœ¼ë©´ ê·¸ëƒ¥ ë‹¨ìˆœ í´ë˜ìŠ¤ì¸ë°,

`@EventSubscriber()` ì˜ ê¸°ëŠ¥ì„ êµ¬í˜„ì„ í•˜ê¸° ìœ„í•´ì„œ íŠ¹ì •ê¸°ëŠ¥ë“¤ì„ êµ¬í˜„ì„ í•´ì•¼ ì‘ë™ì„ í•˜ê²Œ ëœë‹¤. ê·¸ë˜ì„œ

`implemnets EntitySubscriberInterface` ë¥¼ ì¶”ê°€í•´ì¤Œ

`EntitySubscriberInterface` ëŠ” ì–´ë–¤ entityë¥¼ ì“¸ê±´ë°? ë¼ê³  ë¬¼ì–´ë³´ëŠ” ê¸°ëŠ¥ì´ë¯€ë¡œ `<>` ì•ˆì— ì‚¬ìš©í•  ì—”í‹°í‹°ë¥¼ ë„£ì–´ì£¼ì–´ì•¼ í•œë‹¤.

ë‚˜ëŠ” ìƒí’ˆ ì—”í‹°í‹°ì™€ ì—®ì„ê±°ê¸°ë•Œë¬¸ì— ìµœì¢…ì ìœ¼ë¡œëŠ”

`export class ProductSubscriber implements EntitySubscriberInterface<Product>` ì´ë ‡ê²Œ í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´ì¤Œ

ê°„ë‹¨íˆ ë§í•˜ìë©´,

Product ì—”í‹°í‹°ì— ì´ë²¤íŠ¸ê°€ ê°ì§€ë˜ëŠ”ì§€ êµ¬ë…ğŸ‘€(ê°ì‹œ)í•˜ê³  ìˆì„ê²Œìš” ë¼ëŠ” ëœ»ì´ë‹¤.

<br>

<br>

```js
constructor(connection: Connection){
   connection.subscribers.push(this);
}
```

ê·¸ë¦¬ê³  `constructor`ì—ë‹¤ê°€ëŠ” `typeORM`ì—ì„œ ì œê³µí•´ì£¼ëŠ” Connectionì„ ì´ìš©í•œë‹¤.

productí…Œì´ë¸”ë§Œ `subscriber`ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ëŠ”ê²Œ ì•„ë‹ˆê¸° ë•Œë¬¸ì—(ë‹¤ë¥¸í…Œì´ë¸”ì—ì„œë„ ë§Œë“¤ìˆ˜ìˆìœ¼ë‹ˆ)

êµ¬ë…ì •ë³´ì—ë‹¤ê°€ ë‚´ í´ë˜ìŠ¤(=this)ë¥¼ pushí•˜ëŠ”ê²ƒì´ë‹¤. ë‚´ í´ë˜ìŠ¤ë¼ í•¨ì€ `ProductSubscriber` í´ë˜ìŠ¤ë¥¼ ì˜ë¯¸í•œë‹¤.

<br>

```js
listenTo() {
   return Product
}
```

ì–´ë–¤ í…Œì´ë¸”ì„ ì£¼ì‹œí•˜ê³ ìˆì„ê±´ì§€ ì ì–´ì£¼ë©´ ëœë‹¤.

<br>

<br>

`afterInsert` ë§ê³ ë„ êµ‰ì¥íˆ ë§ì€ ì˜µì…˜ë“¤ì´ ìˆë‹¤.

ê·¸ ì˜µì…˜ë“¤ì€ [ê³µì‹ë¬¸ì„œ](https://orkhan.gitbook.io/typeorm/docs/listeners-and-subscribers) ì— ë‚˜ì™€ìˆìœ¼ë‹ˆê¹Œ ë³¸ì¸ë“¤ì´ ì›í•˜ëŠ”ê±¸ë¡œ ì‘ì„±í•˜ë©´ ë¨.

ë‚˜ëŠ” dbì— ì •ë³´ê°€ ìƒˆë¡œ ìƒì„±ë˜ë©´ ê·¸ ë‹¤ìŒì— í•¨ìˆ˜ê°€ ì‹¤í–‰ëìœ¼ë©´ í•˜ë‹ˆê¹Œ `afterInsert` ë¡œ ì‘ì„±í–ˆë‹¤.

`console.log(event);` ë¡œ ì°ì–´ë³´ë©´ `event` ì•ˆì—ëŠ” ì‹¤ì œ dbì— ì €ì¥ëœ ë‚´ìš©ë“¤ì´ ì°íŒë‹¤.

```js
const id = event.entity.id;
const name = event.entity.name;
const description = event.entity.description;
...
...
```

ì´ëŸ°ì‹ìœ¼ë¡œ ë³¸ì¸ì´ ì ì€ ì—”í‹°í‹°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆë‹¤.

ì›í•˜ëŠ”ê²ƒë§Œ êº¼ë‚´ë¨¹ìœ¼ë©´ ë¨ ğŸ

<br>

<br>

<br>

ê·¸ë¦¬ê³  ì´ë ‡ê²Œ gcp ë¹…ì¿¼ë¦¬ì™€ ì´ì–´ì£¼ì–´ì•¼ í•œë‹¤.

```js
const bigQuery = new BigQuery({
  keyFilename: "gcp-bigquery.json",
  projectId: "í”„ë¡œì íŠ¸ì•„ì´ë””",
});

bigQuery.dataset("ë¹…ì¿¼ë¦¬ë°ì´í„°ì´ë¦„").table("ë¹…ì¿¼ë¦¬í…Œì´ë¸”ëª…").insert([
  //ê°ì²´í•˜ë‚˜ë‹¹ 1ì¤„ì…ë ¥
  {
    id,
    name,
    description,
    price,
    isSoldout,
  },
]);
```

ì´ë ‡ê²Œ ë§Œë“¤ì–´ì¤€ `subscriber` íŒŒì¼ì„ ëª¨ë“ˆì—ì„œ `providers`ì— importí•´ì£¼ì–´ì•¼í•œë‹¤.

`product.module.ts` ë¡œ ê°€ì„œ `ProductSubscriber` ë¥¼ import í•´ì£¼ì

```js
providers: [
  ProductSubscriber,
  ProductsResolver,
  ProductsService,
],
```

ë—! (à¸‡á›)à¸§ (à¸‡á– )à¸§

<br>

<br>

<br>

<br>

<br>
